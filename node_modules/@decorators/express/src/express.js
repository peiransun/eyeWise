"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = require("express");
const di_1 = require("@decorators/di");
const meta_1 = require("./meta");
const middleware_1 = require("./middleware");
/**
 * Error Middleware class registration DI token
 */
exports.ERROR_MIDDLEWARE = new di_1.InjectionToken('ERROR_MIDDLEWARE');
/**
 * Attach controllers to express application
 *
 * @param {Express} app Express application
 * @param {Type[]} controllers Controllers array
 */
function attachControllers(app, controllers) {
    controllers.forEach((controller) => registerController(app, controller));
    app.use(errorMiddlewareHandler());
}
exports.attachControllers = attachControllers;
/**
 * Register controller via registering new Router
 *
 * @param {Application} app
 * @param {ExpressClass} Controller
 * @returns
 */
function registerController(app, Controller) {
    const controller = getController(Controller);
    const meta = meta_1.getMeta(controller);
    const router = express_1.Router();
    const routes = meta.routes;
    const url = meta.url;
    const params = meta.params;
    /**
     * Wrap all registered middleware with helper function
     * that can instantiate or get from the container instance of the class
     * or execute given middleware function
     * @see getMiddleware
     */
    const routerMiddleware = (meta.middleware || [])
        .map(middleware => middleware_1.middlewareHandler(middleware));
    /**
     * Apply router middleware
     */
    if (routerMiddleware.length) {
        router.use(...routerMiddleware);
    }
    /**
     * Applying registered routes
     */
    for (const methodName of Object.keys(routes)) {
        const route = routes[methodName];
        const routeHandler = (req, res, next) => {
            const args = extractParameters(req, res, next, params[methodName]);
            return controller[methodName].apply(controller, args);
        };
        const routeMiddleware = (route.middleware || [])
            .map(middleware => middleware_1.middlewareHandler(middleware));
        router[route.method].apply(router, [
            route.url, ...routeMiddleware, routeHandler
        ]);
    }
    app.use(url, router);
    return app;
}
/**
 * Add error middleware to the app
 *
 * @param {Express} app
 */
function errorMiddlewareHandler() {
    return function (error, req, res, next) {
        try {
            const errorMiddleware = di_1.Container.get(exports.ERROR_MIDDLEWARE);
            errorMiddleware.use(error, req, res, next);
        }
        catch (_a) {
            next(error);
        }
    };
}
/**
 * Extract parameters for handlers
 *
 * @param {Request} req
 * @param {Response} res
 * @param {NextFunction} next
 * @param {ParameterConfiguration[]} params
 *
 * @returns {any[]}
 */
function extractParameters(req, res, next, params) {
    if (!params || !params.length) {
        return [req, res, next];
    }
    const args = [];
    for (let { name, index, type } of params) {
        switch (type) {
            case meta_1.ParameterType.RESPONSE:
                args[index] = res;
                break;
            case meta_1.ParameterType.REQUEST:
                args[index] = getParam(req, null, name);
                break;
            case meta_1.ParameterType.NEXT:
                args[index] = next;
                break;
            case meta_1.ParameterType.PARAMS:
                args[index] = getParam(req, 'params', name);
                break;
            case meta_1.ParameterType.QUERY:
                args[index] = getParam(req, 'query', name);
                break;
            case meta_1.ParameterType.BODY:
                args[index] = getParam(req, 'body', name);
                break;
            case meta_1.ParameterType.HEADERS:
                args[index] = getParam(req, 'headers', name);
                break;
            case meta_1.ParameterType.COOKIES:
                args[index] = getParam(req, 'cookies', name);
                break;
        }
    }
    return args;
}
/**
 * Get controller instance from container or instantiate one
 *
 * @param {any} Controller
 *
 * @returns {ExpressClass}
 */
function getController(Controller) {
    try {
        return di_1.Container.get(Controller);
    }
    catch (_a) {
        return new Controller();
    }
}
/**
 * Get parameter value from the source object
 *
 * @param {*} source
 * @param {string} paramType
 * @param {string} name
 *
 * @returns {*}
 */
function getParam(source, paramType, name) {
    let param = source[paramType] || source;
    return param[name] || param;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImV4cHJlc3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBNkg7QUFDN0gsdUNBQTJEO0FBRTNELGlDQUEwRztBQUMxRyw2Q0FBd0U7QUFFeEU7O0dBRUc7QUFDVSxRQUFBLGdCQUFnQixHQUFHLElBQUksbUJBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0FBRXZFOzs7OztHQUtHO0FBQ0gsMkJBQWtDLEdBQVksRUFBRSxXQUFtQjtJQUNqRSxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBZ0IsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLFVBQVUsQ0FBQyxDQUFDLENBQUM7SUFFL0UsR0FBRyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUM7QUFDcEMsQ0FBQztBQUpELDhDQUlDO0FBRUQ7Ozs7OztHQU1HO0FBQ0gsNEJBQTRCLEdBQWdCLEVBQUUsVUFBZ0I7SUFDNUQsTUFBTSxVQUFVLEdBQWlCLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUMzRCxNQUFNLElBQUksR0FBZ0IsY0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzlDLE1BQU0sTUFBTSxHQUFXLGdCQUFNLEVBQUUsQ0FBQztJQUVoQyxNQUFNLE1BQU0sR0FBVyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ25DLE1BQU0sR0FBRyxHQUFXLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDN0IsTUFBTSxNQUFNLEdBQVcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUVuQzs7Ozs7T0FLRztJQUNILE1BQU0sZ0JBQWdCLEdBQXFCLENBQUMsSUFBSSxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUM7U0FDL0QsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsOEJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUVwRDs7T0FFRztJQUNILEVBQUUsQ0FBQyxDQUFDLGdCQUFn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LElBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxNQUFNLENBQUM7SUFFeEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUM7QUFDOUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3RIYW5kbGVyLCBFcnJvclJlcXVlc3RIYW5kbGVyLCBBcHBsaWNhdGlvbiwgUm91dGVyLCBFeHByZXNzLCBSZXF1ZXN0LCBSZXNwb25zZSwgTmV4dEZ1bmN0aW9uIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgeyBDb250YWluZXIsIEluamVjdGlvblRva2VuIH0gZnJvbSAnQGRlY29yYXRvcnMvZGknO1xuXG5pbXBvcnQgeyBFeHByZXNzTWV0YSwgZ2V0TWV0YSwgUGFyYW1ldGVyVHlwZSwgRXhwcmVzc0NsYXNzLCBSb3V0ZSwgUGFyYW1ldGVyQ29uZmlndXJhdGlvbiB9IGZyb20gJy4vbWV0YSc7XG5pbXBvcnQgeyBtaWRkbGV3YXJlSGFuZGxlciwgRXJyb3JNaWRkbGV3YXJlLCBUeXBlIH0gZnJvbSAnLi9taWRkbGV3YXJlJztcblxuLyoqXG4gKiBFcnJvciBNaWRkbGV3YXJlIGNsYXNzIHJlZ2lzdHJhdGlvbiBESSB0b2tlblxuICovXG5leHBvcnQgY29uc3QgRVJST1JfTUlERExFV0FSRSA9IG5ldyBJbmplY3Rpb25Ub2tlbignRVJST1JfTUlERExFV0FSRScpO1xuXG4vKipcbiAqIEF0dGFjaCBjb250cm9sbGVycyB0byBleHByZXNzIGFwcGxpY2F0aW9uXG4gKlxuICogQHBhcmFtIHtFeHByZXNzfSBhcHAgRXhwcmVzcyBhcHBsaWNhdGlvblxuICogQHBhcmFtIHtUeXBlW119IGNvbnRyb2xsZXJzIENvbnRyb2xsZXJzIGFycmF5XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhdHRhY2hDb250cm9sbGVycyhhcHA6IEV4cHJlc3MsIGNvbnRyb2xsZXJzOiBUeXBlW10pIHtcbiAgY29udHJvbGxlcnMuZm9yRWFjaCgoY29udHJvbGxlcjogVHlwZSkgPT4gcmVnaXN0ZXJDb250cm9sbGVyKGFwcCwgY29udHJvbGxlcikpO1xuXG4gIGFwcC51c2UoZXJyb3JNaWRkbGV3YXJlSGFuZGxlcigpKTtcbn1cblxuLyoqXG4gKiBSZWdpc3RlciBjb250cm9sbGVyIHZpYSByZWdpc3RlcmluZyBuZXcgUm91dGVyXG4gKlxuICogQHBhcmFtIHtBcHBsaWNhdGlvbn0gYXBwXG4gKiBAcGFyYW0ge0V4cHJlc3NDbGFzc30gQ29udHJvbGxlclxuICogQHJldHVybnNcbiAqL1xuZnVuY3Rpb24gcmVnaXN0ZXJDb250cm9sbGVyKGFwcDogQXBwbGljYXRpb24sIENvbnRyb2xsZXI6IFR5cGUpIHtcbiAgY29uc3QgY29udHJvbGxlcjogRXhwcmVzc0NsYXNzID0gZ2V0Q29udHJvbGxlcihDb250cm9sbGVyKTtcbiAgY29uc3QgbWV0YTogRXhwcmVzc01ldGEgPSBnZXRNZXRhKGNvbnRyb2xsZXIpO1xuICBjb25zdCByb3V0ZXI6IFJvdXRlciA9IFJvdXRlcigpO1xuXG4gIGNvbnN0IHJvdXRlczogb2JqZWN0ID0gbWV0YS5yb3V0ZXM7XG4gIGNvbnN0IHVybDogc3RyaW5nID0gbWV0YS51cmw7XG4gIGNvbnN0IHBhcmFtczogb2JqZWN0ID0gbWV0YS5wYXJhbXM7XG5cbiAgLyoqXG4gICAqIFdyYXAgYWxsIHJlZ2lzdGVyZWQgbWlkZGxld2FyZSB3aXRoIGhlbHBlciBmdW5jdGlvblxuICAgKiB0aGF0IGNhbiBpbnN0YW50aWF0ZSBvciBnZXQgZnJvbSB0aGUgY29udGFpbmVyIGluc3RhbmNlIG9mIHRoZSBjbGFzc1xuICAgKiBvciBleGVjdXRlIGdpdmVuIG1pZGRsZXdhcmUgZnVuY3Rpb25cbiAgICogQHNlZSBnZXRNaWRkbGV3YXJlXG4gICAqL1xuICBjb25zdCByb3V0ZXJNaWRkbGV3YXJlOiBSZXF1ZXN0SGFuZGxlcltdID0gKG1ldGEubWlkZGxld2FyZSB8fCBbXSlcbiAgICAubWFwKG1pZGRsZXdhcmUgPT4gbWlkZGxld2FyZUhhbmRsZXIobWlkZGxld2FyZSkpO1xuXG4gIC8qKlxuICAgKiBBcHBseSByb3V0ZXIgbWlkZGxld2FyZVxuICAgKi9cbiAgaWYgKHJvdXRlck1pZGRsZXdhcmUubGVuZ3RoKSB7XG4gICAgcm91dGVyLnVzZSguLi5yb3V0ZXJNaWRkbGV3YXJlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseWluZyByZWdpc3RlcmVkIHJvdXRlc1xuICAgKi9cbiAgZm9yIChjb25zdCBtZXRob2ROYW1lIG9mIE9iamVjdC5rZXlzKHJvdXRlcykpIHtcbiAgICBjb25zdCByb3V0ZTogUm91dGUgPSByb3V0ZXNbbWV0aG9kTmFtZV07XG5cbiAgICBjb25zdCByb3V0ZUhhbmRsZXIgPSAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgICAgIGNvbnN0IGFyZ3MgPSBleHRyYWN0UGFyYW1ldGVycyhyZXEsIHJlcywgbmV4dCwgcGFyYW1zW21ldGhvZE5hbWVdKTtcblxuICAgICAgcmV0dXJuIGNvbnRyb2xsZXJbbWV0aG9kTmFtZV0uYXBwbHkoY29udHJvbGxlciwgYXJncyk7XG4gICAgfTtcblxuICAgIGNvbnN0IHJvdXRlTWlkZGxld2FyZTogUmVxdWVzdEhhbmRsZXJbXSA9IChyb3V0ZS5taWRkbGV3YXJlIHx8IFtdKVxuICAgICAgLm1hcChtaWRkbGV3YXJlID0+IG1pZGRsZXdhcmVIYW5kbGVyKG1pZGRsZXdhcmUpKTtcblxuICAgIHJvdXRlcltyb3V0ZS5tZXRob2RdLmFwcGx5KHJvdXRlciwgW1xuICAgICAgcm91dGUudXJsLCAuLi5yb3V0ZU1pZGRsZXdhcmUsIHJvdXRlSGFuZGxlclxuICAgIF0pO1xuICB9XG5cbiAgYXBwLnVzZSh1cmwsIHJvdXRlcik7XG5cbiAgcmV0dXJuIGFwcDtcbn1cblxuLyoqXG4gKiBBZGQgZXJyb3IgbWlkZGxld2FyZSB0byB0aGUgYXBwXG4gKlxuICogQHBhcmFtIHtFeHByZXNzfSBhcHBcbiAqL1xuZnVuY3Rpb24gZXJyb3JNaWRkbGV3YXJlSGFuZGxlcigpOiBFcnJvclJlcXVlc3RIYW5kbGVyIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKGVycm9yOiBFcnJvciwgcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZXJyb3JNaWRkbGV3YXJlOiBFcnJvck1pZGRsZXdhcmUgPSBDb250YWluZXIuZ2V0KEVSUk9SX01JRERMRVdBUkUpO1xuICAgICAgZXJyb3JNaWRkbGV3YXJlLnVzZShlcnJvciwgcmVxLCByZXMsIG5leHQpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgbmV4dChlcnJvcik7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogRXh0cmFjdCBwYXJhbWV0ZXJzIGZvciBoYW5kbGVyc1xuICpcbiAqIEBwYXJhbSB7UmVxdWVzdH0gcmVxXG4gKiBAcGFyYW0ge1Jlc3BvbnNlfSByZXNcbiAqIEBwYXJhbSB7TmV4dEZ1bmN0aW9ufSBuZXh0XG4gKiBAcGFyYW0ge1BhcmFtZXRlckNvbmZpZ3VyYXRpb25bXX0gcGFyYW1zXG4gKlxuICogQHJldHVybnMge2FueVtdfVxuICovXG5mdW5jdGlvbiBleHRyYWN0UGFyYW1ldGVycyhyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UsIG5leHQ6IE5leHRGdW5jdGlvbiwgcGFyYW1zOiBQYXJhbWV0ZXJDb25maWd1cmF0aW9uW10pOiBhbnlbXSB7XG4gIGlmICghcGFyYW1zIHx8ICFwYXJhbXMubGVuZ3RoKSB7XG4gICAgcmV0dXJuIFsgcmVxLCByZXMsIG5leHQgXTtcbiAgfVxuXG4gIGNvbnN0IGFyZ3MgPSBbXTtcblxuICBmb3IgKGxldCB7IG5hbWUsIGluZGV4LCB0eXBlIH0gb2YgcGFyYW1zKSB7XG5cbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5SRVNQT05TRTpcbiAgICAgICAgYXJnc1tpbmRleF0gPSByZXM7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLlJFUVVFU1Q6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCBudWxsLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuTkVYVDpcbiAgICAgICAgYXJnc1tpbmRleF0gPSBuZXh0O1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5QQVJBTVM6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCAncGFyYW1zJywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLlFVRVJZOlxuICAgICAgICBhcmdzW2luZGV4XSA9IGdldFBhcmFtKHJlcSwgJ3F1ZXJ5JywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBQYXJhbWV0ZXJUeXBlLkJPRFk6XG4gICAgICAgIGFyZ3NbaW5kZXhdID0gZ2V0UGFyYW0ocmVxLCAnYm9keScsIG5hbWUpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgUGFyYW1ldGVyVHlwZS5IRUFERVJTOlxuICAgICAgICBhcmdzW2luZGV4XSA9IGdldFBhcmFtKHJlcSwgJ2hlYWRlcnMnLCBuYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFBhcmFtZXRlclR5cGUuQ09PS0lFUzpcbiAgICAgICAgYXJnc1tpbmRleF0gPSBnZXRQYXJhbShyZXEsICdjb29raWVzJywgbmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICB9XG5cbiAgcmV0dXJuIGFyZ3M7XG59XG5cbi8qKlxuICogR2V0IGNvbnRyb2xsZXIgaW5zdGFuY2UgZnJvbSBjb250YWluZXIgb3IgaW5zdGFudGlhdGUgb25lXG4gKlxuICogQHBhcmFtIHthbnl9IENvbnRyb2xsZXJcbiAqXG4gKiBAcmV0dXJucyB7RXhwcmVzc0NsYXNzfVxuICovXG5mdW5jdGlvbiBnZXRDb250cm9sbGVyKENvbnRyb2xsZXI6IFR5cGUpOiBFeHByZXNzQ2xhc3Mge1xuICB0cnkge1xuICAgIHJldHVybiBDb250YWluZXIuZ2V0KENvbnRyb2xsZXIpO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gbmV3IENvbnRyb2xsZXIoKTtcbiAgfVxufVxuXG4vKipcbiAqIEdldCBwYXJhbWV0ZXIgdmFsdWUgZnJvbSB0aGUgc291cmNlIG9iamVjdFxuICpcbiAqIEBwYXJhbSB7Kn0gc291cmNlXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFyYW1UeXBlXG4gKiBAcGFyYW0ge3N0cmluZ30gbmFtZVxuICpcbiAqIEByZXR1cm5zIHsqfVxuICovXG5mdW5jdGlvbiBnZXRQYXJhbShzb3VyY2U6IGFueSwgcGFyYW1UeXBlOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IGFueSB7XG4gIGxldCBwYXJhbSA9IHNvdXJjZVtwYXJhbVR5cGVdIHx8IHNvdXJjZTtcblxuICByZXR1cm4gcGFyYW1bbmFtZV0gfHwgcGFyYW07XG59XG4iXX0=